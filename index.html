<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GPS Tacho</title>
    
    <!-- PWA Settings & Manifest für Mobile Homescreen -->
    <meta name="theme-color" content="#050505">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="GPS Tacho">

    <!-- Icon als Base64 SVG (Funktioniert für Browser Tabs) -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCI+PHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiByeD0iMTIiIGZpbGw9IiMwNTA1MDUiLz48cGF0aCBkPSJNMTAsNTQgQTI2LDI2IDAgMSwxIDU0LDU0IiBmaWxsPSJub25lIiBzdHJva2U9IiMwMGYzZmYiIHN0cm9rZS13aWR0aD0iNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+PHBhdGggZD0iTTMyLDMyIEw0OCwxNiIgc3Ryb2tlPSIjZmYyYTJhIiBzdHJva2Utd2lkdGg9IjQiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxjaXJjbGUgY3g9IjMyIiBjeT0iMzIiIHI9IjUiIGZpbGw9IiMzMzMiLz48L3N2Zz4=">
    
    <!-- Apple Touch Icon (Wichtig für iOS Homescreen) -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCI+PHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiByeD0iMTIiIGZpbGw9IiMwNTA1MDUiLz48cGF0aCBkPSJNMTAsNTQgQTI2LDI2IDAgMSwxIDU0LDU0IiBmaWxsPSJub25lIiBzdHJva2U9IiMwMGYzZmYiIHN0cm9rZS13aWR0aD0iNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+PHBhdGggZD0iTTMyLDMyIEw0OCwxNiIgc3Ryb2tlPSIjZmYyYTJhIiBzdHJva2Utd2lkdGg9IjQiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxjaXJjbGUgY3g9IjMyIiBjeT0iMzIiIHI9IjUiIGZpbGw9IiMzMzMiLz48L3N2Zz4=">

    <!-- Web App Manifest (Wichtig für Android Homescreen) -->
    <link rel="manifest" href='data:application/manifest+json,{"name":"GPS Tacho","short_name":"Tacho","start_url":".","display":"standalone","background_color":"#050505","theme_color":"#00f3ff","icons":[{"src":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCI+PHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiByeD0iMTIiIGZpbGw9IiMwNTA1MDUiLz48cGF0aCBkPSJNMTAsNTQgQTI2LDI2IDAgMSwxIDU0LDU0IiBmaWxsPSJub25lIiBzdHJva2U9IiMwMGYzZmYiIHN0cm9rZS13aWR0aD0iNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+PHBhdGggZD0iTTMyLDMyIEw0OCwxNiIgc3Ryb2tlPSIjZmYyYTJhIiBzdHJva2Utd2lkdGg9IjQiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxjaXJjbGUgY3g9IjMyIiBjeT0iMzIiIHI9IjUiIGZpbGw9IiMzMzMiLz48L3N2Zz4=","sizes":"192x192","type":"image/svg+xml"}]}'>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #050505;
            --bg-panel: rgba(30, 30, 40, 0.6);
            --accent-cyan: #00f3ff;
            --accent-purple: #bc13fe;
            --accent-red: #ff2a2a;
            --accent-green: #0aff60;
            --text-main: #ffffff;
            --text-muted: #8888aa;
        }

        body {
            font-family: 'Orbitron', sans-serif;
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 30%, #1a1a25 0%, #000000 70%);
            color: var(--text-main);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
            user-select: none;
            /* Wichtig für iOS Fullscreen */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .container {
            width: 100%;
            max-width: 500px;
            padding: 10px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            justify-content: space-between;
            padding-bottom: 20px;
            position: relative;
        }

        /* TACHO BEREICH */
        .gauge-container {
            position: relative;
            width: 100%;
            max-width: 360px;
            aspect-ratio: 1/1;
            margin-top: 10px;
            filter: drop-shadow(0 0 20px rgba(0, 243, 255, 0.1));
        }

        canvas { width: 100%; height: 100%; }

        /* Digitaler Wert */
        .digital-center {
            position: absolute;
            top: 70%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 10;
            pointer-events: none;
        }

        .speed-big {
            font-size: 3.5rem;
            font-weight: 700;
            line-height: 0.9;
            background: linear-gradient(180deg, #fff, #aaa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        .unit-label {
            font-size: 0.8rem;
            color: var(--accent-cyan);
            letter-spacing: 3px;
            margin-top: 5px;
            opacity: 0.8;
        }

        /* STEUERUNG */
        .controls-panel {
            width: 100%;
            background: var(--bg-panel);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 24px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
            z-index: 20;
        }

        /* Mode Buttons */
        .mode-row {
            display: flex;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 4px;
            gap: 2px;
        }

        .mode-btn {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.75rem;
            padding: 12px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
            white-space: nowrap;
        }

        .mode-btn.active {
            background: rgba(255,255,255,0.1);
            color: var(--accent-cyan);
            text-shadow: 0 0 8px var(--accent-cyan);
            font-weight: 700;
        }

        /* Timer & Status */
        .info-box {
            text-align: center;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .timer-val {
            font-size: 3rem;
            color: var(--text-main);
            text-shadow: 0 0 10px rgba(255,255,255,0.3);
            font-variant-numeric: tabular-nums;
        }

        .status-msg {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Hold Bar */
        .hold-track {
            width: 100%;
            height: 4px;
            background: #222;
            margin-top: 10px;
            border-radius: 2px;
            overflow: hidden;
            display: none;
        }
        .hold-fill {
            height: 100%;
            width: 0%;
            background: var(--accent-cyan);
            box-shadow: 0 0 10px var(--accent-cyan);
            transition: width 0.1s linear;
        }

        /* Action Buttons Area */
        .action-area {
            display: flex;
            gap: 10px;
        }

        /* Main Button */
        .btn-main {
            flex: 3;
            padding: 18px;
            border: none;
            border-radius: 14px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .btn-logs {
            flex: 1;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-muted);
            border-radius: 14px;
            font-family: 'Orbitron', sans-serif;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .btn-start {
            background: linear-gradient(90deg, var(--accent-cyan), #00aaff);
            color: #000;
            box-shadow: 0 5px 20px rgba(0, 243, 255, 0.3);
        }
        
        .btn-start:active { transform: scale(0.98); opacity: 0.9; }

        .btn-stop {
            background: rgba(255, 42, 42, 0.2);
            border: 1px solid var(--accent-red);
            color: var(--accent-red);
            text-shadow: 0 0 8px var(--accent-red);
        }

        /* Overlay */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(10px);
            z-index: 100;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .overlay.active { opacity: 1; pointer-events: auto; }
        
        .cnt-num {
            font-size: 10rem; font-weight: 900;
            color: transparent;
            -webkit-text-stroke: 2px var(--accent-cyan);
            text-shadow: 0 0 30px var(--accent-cyan);
            animation: zoomPulse 0.8s ease-out;
        }
        @keyframes zoomPulse { 0% { transform: scale(0.5); opacity: 0; } 60% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); } }

        /* Modals (Base) */
        .modal-base {
            position: absolute; z-index: 300;
            background: #15151a; border: 1px solid #333;
            box-shadow: 0 0 50px rgba(0,0,0,0.9);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0; pointer-events: none;
            display: flex; flex-direction: column;
        }
        .modal-base.open { opacity: 1; pointer-events: auto; }

        /* WICHTIG: Höherer Z-Index für Overlays über der History */
        #renameModal, #confirmModal {
            z-index: 400 !important;
        }

        /* Custom Modal (Centered) */
        .custom-modal {
            top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
            width: 85%; padding: 25px; border-radius: 20px; gap: 20px;
        }
        .custom-modal.open { transform: translate(-50%, -50%) scale(1); }

        /* Debug Modal */
        .debug-modal {
            top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
            width: 85%; padding: 25px; border-radius: 20px; gap: 15px;
            border: 1px solid var(--accent-red);
            box-shadow: 0 0 50px rgba(255, 42, 42, 0.2);
        }
        .debug-modal.open { transform: translate(-50%, -50%) scale(1); }

        /* History Modal */
        .history-modal {
            bottom: -100%; left: 0; width: 100%; height: 80%;
            border-top-left-radius: 30px; border-top-right-radius: 30px;
            padding: 20px; box-sizing: border-box;
            border-bottom: none; border-left: none; border-right: none;
        }
        .history-modal.open { bottom: 0; }
        
        .m-title { color: #fff; margin: 0; font-size: 1.2rem; text-align: center; }
        .m-close { margin-top:10px; padding:12px; background:#333; border:none; color:#aaa; border-radius:8px; width: 100%; cursor: pointer; font-weight:bold;}

        .input-group { display: flex; flex-direction: column; gap: 5px; }
        .input-group input {
            background: #0f0f15; border: 1px solid #333; color: #fff;
            padding: 15px; font-size: 1.2rem; border-radius: 10px;
            font-family: inherit; text-align: center;
        }

        /* GPS Status */
        .gps-stat {
            position: absolute; top: 10px; right: 10px;
            font-size: 0.7rem; color: #555;
            display: flex; align-items: center; gap: 6px;
            background: rgba(0,0,0,0.5); padding: 4px 10px; border-radius: 20px;
            border: 1px solid #333; z-index: 50;
            cursor: pointer; user-select: none;
        }
        .dot { width: 6px; height: 6px; border-radius: 50%; background: #444; }
        .dot.ok { background: var(--accent-green); box-shadow: 0 0 6px var(--accent-green); }
        .dot.bad { background: #ffcc00; animation: blink 1s infinite; }
        .dot.sim { background: var(--accent-purple); box-shadow: 0 0 6px var(--accent-purple); }
        @keyframes blink { 50% { opacity: 0.3; } }
        
        /* History List Styling */
        .hist-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .hist-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        
        .hist-item { 
            background: #1a1a20; padding: 15px; border-radius: 12px; 
            display: flex; justify-content: space-between; align-items: center; 
            border-left: 3px solid #333;
            transition: all 0.2s;
        }
        .hist-item.new { border-left-color: var(--accent-green); }
        
        .h-left { display: flex; flex-direction: column; gap: 4px; }
        .h-title { font-weight: bold; color: #fff; font-size: 1rem; }
        .h-meta { font-size: 0.75rem; color: #666; display: flex; gap: 10px; }
        
        .h-right { display: flex; align-items: center; gap: 10px; }
        .h-time { font-size: 1.4rem; color: var(--accent-cyan); font-weight: 700; }
        
        .h-actions { display: flex; gap: 5px; }
        .h-btn { 
            background: #2a2a30; border: none; color: #888; 
            width: 32px; height: 32px; border-radius: 6px; 
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 1.1rem; transition: all 0.2s;
        }
        .h-btn:hover { background: #444; color: #fff; }
        .h-btn.del:hover { background: rgba(255, 42, 42, 0.2); color: var(--accent-red); }

        /* Slider */
        input[type=range] { width: 100%; -webkit-appearance: none; background: transparent; margin: 20px 0; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: var(--accent-cyan); cursor: pointer; margin-top: -10px; box-shadow: 0 0 10px var(--accent-cyan); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #333; border-radius: 2px; }
    </style>
</head>
<body>

    <div id="overlay" class="overlay"><div id="overlayText" class="cnt-num">3</div></div>

    <div class="gps-stat" onclick="triggerDebug()">
        <div id="gpsDot" class="dot"></div>
        <span id="gpsTxt">NO GPS</span>
    </div>

    <!-- Debug Modal -->
    <div id="debugModal" class="modal-base debug-modal">
        <h3 class="m-title" style="color:var(--accent-red)">DEV CONSOLE</h3>
        <div style="text-align:center;">
            <label style="color:#888; font-size:0.8rem;">MANUELL</label>
            <input type="range" min="0" max="300" value="0" id="debugSlider" oninput="updateDebugSpeed(this.value)">
            <div id="debugVal" style="font-size:1.5rem; font-weight:bold;">0 KM/H</div>
        </div>
        <button class="m-close" onclick="startAutoSim()" style="background:var(--accent-purple); color:#fff;">SIMULATION STARTEN</button>
        <button class="m-close" onclick="closeDebug(true)" style="background:#444; color:#fff;">RESET / GPS AN</button>
        <button class="m-close" onclick="closeDebug(false)">SCHLIESSEN</button>
    </div>

    <!-- Custom Mode Modal -->
    <div id="customModal" class="modal-base custom-modal">
        <h3 class="m-title">BENUTZERDEFINIERT</h3>
        <div class="input-group">
            <label>START (KM/H)</label>
            <input type="number" id="customStart" placeholder="0" value="0">
        </div>
        <div class="input-group">
            <label>ZIEL (KM/H)</label>
            <input type="number" id="customEnd" placeholder="100" value="100">
        </div>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="m-close" onclick="closeCustom()" style="margin-top:0;">ABBRECHEN</button>
            <button class="m-close" onclick="applyCustom()" style="margin-top:0; background:var(--accent-cyan); color:#000;">STARTEN</button>
        </div>
    </div>

    <!-- Rename Modal -->
    <div id="renameModal" class="modal-base custom-modal">
        <h3 class="m-title">UMBENENNEN</h3>
        <div class="input-group">
            <input type="text" id="renameInput" placeholder="Name eingeben...">
        </div>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="m-close" onclick="closeRename()" style="margin-top:0;">ABBRECHEN</button>
            <button class="m-close" onclick="confirmRename()" style="margin-top:0; background:var(--accent-cyan); color:#000;">SPEICHERN</button>
        </div>
    </div>

    <!-- Delete Confirm Modal -->
    <div id="confirmModal" class="modal-base custom-modal" style="text-align:center">
        <h3 class="m-title">LÖSCHEN?</h3>
        <p style="color:#888; margin-bottom:20px;">Eintrag wirklich löschen?</p>
        <div style="display:flex; gap:10px;">
            <button class="m-close" onclick="closeConfirm()">NEIN</button>
            <button class="m-close" onclick="executeDelete()" style="background:var(--accent-red); color:#fff;">JA, LÖSCHEN</button>
        </div>
    </div>

    <!-- History Modal -->
    <div id="histModal" class="modal-base history-modal">
        <div class="hist-header">
            <span class="m-title" style="color:var(--accent-cyan)">DATA CENTER</span>
            <button onclick="toggleHistory()" style="background:none; border:none; color:#666; font-size:1.5rem; cursor:pointer;">×</button>
        </div>
        <div class="hist-list" id="histList"></div>
        <button class="m-close" onclick="clearAllLogs()">ALLE LÖSCHEN</button>
    </div>

    <div class="container">
        <div class="gauge-container">
            <canvas id="gaugeCanvas"></canvas>
            <div class="digital-center">
                <div class="speed-big" id="digiSpeed">0</div>
                <div class="unit-label">KM/H</div>
            </div>
        </div>

        <div class="controls-panel">
            <div class="mode-row">
                <button class="mode-btn active" onclick="setMode(0, 100, this)">0-100</button>
                <button class="mode-btn" onclick="setMode(10, 100, this)">10-100</button>
                <button class="mode-btn" onclick="setMode(100, 200, this)">100-200</button>
                <button class="mode-btn" id="btnCustom" onclick="openCustom()">CUSTOM</button>
            </div>

            <div class="info-box">
                <div class="timer-val" id="timer">0.00</div>
                <div class="status-msg" id="status">Bereit</div>
                <div class="hold-track" id="holdTrack"><div class="hold-fill" id="holdFill"></div></div>
            </div>

            <div class="action-area">
                <button class="btn-logs" onclick="toggleHistory()">LOGS</button>
                <button class="btn-main btn-start" onclick="handleBtn()" id="mainBtn">START</button>
            </div>
        </div>
    </div>

    <script>
        const MAX_SPEED = 260;
        const HOLD_TIME = 3000;
        const TOLERANCE = 2.0; 
        const STATIC_TOLERANCE = 2.0;
        const STORAGE_KEY = 'pro_tacho_logs';

        let state = {
            speed: 0, displaySpeed: 0,
            modeStart: 0, modeEnd: 100,
            phase: 'IDLE', startTime: 0, holdStart: 0, timerId: null,
            isSimulating: false, simInterval: null
        };

        let pendingDeleteId = null;
        let pendingRenameId = null;

        const ui = {
            can: document.getElementById('gaugeCanvas'),
            digi: document.getElementById('digiSpeed'),
            timer: document.getElementById('timer'),
            status: document.getElementById('status'),
            btn: document.getElementById('mainBtn'),
            ovl: document.getElementById('overlay'),
            ovlTxt: document.getElementById('overlayText'),
            holdTrack: document.getElementById('holdTrack'),
            holdFill: document.getElementById('holdFill'),
            gpsDot: document.getElementById('gpsDot'),
            gpsTxt: document.getElementById('gpsTxt'),
            histModal: document.getElementById('histModal'),
            histList: document.getElementById('histList'),
            customModal: document.getElementById('customModal'),
            customStart: document.getElementById('customStart'),
            customEnd: document.getElementById('customEnd'),
            btnCustom: document.getElementById('btnCustom'),
            debugModal: document.getElementById('debugModal'),
            debugVal: document.getElementById('debugVal'),
            debugSlider: document.getElementById('debugSlider'),
            renameModal: document.getElementById('renameModal'),
            renameInput: document.getElementById('renameInput'),
            confirmModal: document.getElementById('confirmModal')
        };
        const ctx = ui.can.getContext('2d');
        let dim = { w:0, h:0, cx:0, cy:0, r:0 };

        function init() {
            resize(); window.addEventListener('resize', resize);
            loop(); startGPS(); renderHistory();
        }

        function resize() {
            const dpr = window.devicePixelRatio || 1;
            const rect = ui.can.parentElement.getBoundingClientRect();
            if (rect.width === 0) return;
            ui.can.width = rect.width * dpr; ui.can.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            dim.w = rect.width; dim.h = rect.height;
            dim.cx = dim.w/2; dim.cy = dim.h/2; 
            dim.r = Math.max(0, (dim.w/2) - 15); 
        }

        /* --- DEBUG --- */
        let clickCount = 0, clickTimer = null;
        function triggerDebug() {
            clickCount++;
            if(clickTimer) clearTimeout(clickTimer);
            clickTimer = setTimeout(() => clickCount = 0, 800);
            if(clickCount >= 5) { ui.debugModal.classList.add('open'); clickCount = 0; }
        }
        function closeDebug(reset) {
            ui.debugModal.classList.remove('open');
            if(reset) {
                stopAutoSim();
                state.isSimulating = false;
                state.speed = 0;
                ui.debugSlider.value = 0;
                ui.debugVal.textContent = "0 KM/H";
                ui.gpsDot.className = "dot searching";
                ui.gpsTxt.textContent = "GPS RESTORE";
            }
        }
        function updateDebugSpeed(val) {
            state.isSimulating = true; stopAutoSim();
            state.speed = parseFloat(val);
            ui.debugVal.textContent = state.speed + " KM/H";
            ui.gpsDot.className = "dot sim"; ui.gpsTxt.textContent = "DEV SIM";
            checkLogic();
        }
        function startAutoSim() {
            state.isSimulating = true; ui.gpsDot.className = "dot sim"; ui.gpsTxt.textContent = "AUTO SIM";
            state.speed = 0; ui.debugSlider.value = 0; ui.debugVal.textContent = "0 KM/H";
            if(state.simInterval) clearInterval(state.simInterval);
            let simSpeed = 0;
            state.simInterval = setInterval(() => {
                if(simSpeed < 300) {
                    simSpeed += 0.8; state.speed = simSpeed;
                    ui.debugSlider.value = simSpeed; ui.debugVal.textContent = Math.round(simSpeed) + " KM/H";
                    checkLogic();
                } else stopAutoSim();
            }, 30);
        }
        function stopAutoSim() { if(state.simInterval) clearInterval(state.simInterval); }

        /* --- MODALS --- */
        function openCustom() { ui.customModal.classList.add('open'); }
        function closeCustom() { ui.customModal.classList.remove('open'); }
        function toggleHistory() { ui.histModal.classList.toggle('open'); }
        
        function applyCustom() {
            const s = parseInt(ui.customStart.value); const e = parseInt(ui.customEnd.value);
            if (isNaN(s) || isNaN(e) || s >= e || e > 350) return;
            state.modeStart = s; state.modeEnd = e;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            ui.btnCustom.classList.add('active'); ui.btnCustom.textContent = `${s}-${e}`;
            closeCustom(); resetAll(); ui.status.textContent = `MODUS: ${s} - ${e}`;
        }

        /* --- MEASUREMENT LOGIC --- */
        function setMode(s, e, el) {
            if(state.phase !== 'IDLE' && state.phase !== 'FINISHED') return;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active'); ui.btnCustom.textContent = "CUSTOM";
            state.modeStart = s; state.modeEnd = e;
            resetAll(); ui.status.textContent = `MODUS: ${s} - ${e}`;
        }
        function handleBtn() {
            if(state.phase !== 'IDLE' && state.phase !== 'FINISHED') { resetAll(); return; }
            if(state.modeStart === 0) initStaticStart(); else startRollingSequence();
        }
        function initStaticStart() { state.phase = 'CHECK_STATIC'; setBtnState('stop'); ui.status.textContent = "BITTE ANHALTEN..."; }
        function runCountdown() {
            state.phase = 'COUNTDOWN'; ui.ovl.classList.add('active');
            let c = 3; updateOverlay(c);
            let iv = setInterval(() => {
                c--;
                if(c > 0) updateOverlay(c);
                else { clearInterval(iv); updateOverlay("GO"); setTimeout(() => { ui.ovl.classList.remove('active'); arm("GIB GAS!"); }, 800); }
            }, 1000);
        }
        function updateOverlay(txt) {
            ui.ovlTxt.style.animation = 'none'; ui.ovlTxt.offsetHeight;
            ui.ovlTxt.style.animation = 'zoomPulse 0.8s ease-out'; ui.ovlTxt.textContent = txt;
        }
        function startRollingSequence() {
            state.phase = 'CHECK_ROLLING'; setBtnState('stop');
            ui.holdTrack.style.display = 'block'; ui.holdFill.style.width = '0%';
            ui.status.textContent = `HALTE ${state.modeStart} KM/H`;
        }
        function checkLogic() {
            if(state.phase === 'IDLE' || state.phase === 'FINISHED') return;
            if(state.phase === 'CHECK_STATIC') {
                if(state.speed < STATIC_TOLERANCE) runCountdown(); else ui.status.textContent = `ANHALTEN! (${Math.round(state.speed)})`;
            }
            if(state.phase === 'CHECK_ROLLING') {
                if(state.speed >= (state.modeStart-TOLERANCE) && state.speed <= (state.modeStart+TOLERANCE)) {
                    state.phase = 'HOLDING'; state.holdStart = Date.now();
                } else ui.status.textContent = state.speed < state.modeStart ? `ZU LANGSAM` : `ZU SCHNELL`;
            }
            if(state.phase === 'HOLDING') {
                if(state.speed < (state.modeStart-TOLERANCE) || state.speed > (state.modeStart+TOLERANCE)) {
                    state.phase = 'CHECK_ROLLING'; ui.holdFill.style.width = '0%';
                }
                const prog = Math.min(((Date.now()-state.holdStart)/HOLD_TIME)*100, 100);
                ui.holdFill.style.width = prog + '%'; ui.status.textContent = "HALTEN...";
                if(prog >= 100) { state.phase = 'ARMED'; ui.holdFill.style.background = "#0aff60"; arm("GO! GIB GAS!"); }
            }
            if(state.phase === 'ARMED') {
                const trigger = state.modeStart === 0 ? 1.5 : (state.modeStart+TOLERANCE);
                if(state.speed > trigger) startRun();
            }
            if(state.phase === 'RUNNING') { if(state.speed >= state.modeEnd) finishRun(); }
        }
        function arm(msg) {
            state.phase = 'ARMED'; ui.status.textContent = msg; ui.status.style.color = "#0aff60";
            if(state.modeStart > 0) setTimeout(() => ui.holdTrack.style.display='none', 1000);
        }
        function startRun() {
            state.phase = 'RUNNING'; state.startTime = Date.now();
            ui.status.textContent = "MESSUNG LÄUFT"; ui.status.style.color = "var(--accent-cyan)";
            state.timerId = setInterval(() => { ui.timer.textContent = ((Date.now() - state.startTime)/1000).toFixed(2); }, 30);
        }
        function finishRun() {
            clearInterval(state.timerId); state.phase = 'FINISHED';
            const timeStr = ((Date.now() - state.startTime)/1000).toFixed(2);
            ui.timer.textContent = timeStr; ui.status.textContent = `ZIEL ERREICHT!`;
            setBtnState('start', "NEUER START"); saveRun(timeStr);
        }
        function resetAll() {
            clearInterval(state.timerId); state.phase = 'IDLE'; state.holdStart = 0;
            ui.timer.textContent = "0.00"; ui.status.textContent = "BEREIT";
            ui.status.style.color = "var(--text-muted)"; ui.holdTrack.style.display = 'none';
            ui.holdFill.style.width = '0%'; ui.holdFill.style.background = "var(--accent-cyan)"; setBtnState('start', "START");
        }
        function setBtnState(type, txt) {
            ui.btn.className = type === 'stop' ? "btn-logs btn-stop" : "btn-main btn-start";
            ui.btn.textContent = type === 'stop' ? "ABBRECHEN" : (txt || "START");
            if(type === 'stop') { ui.btn.classList.remove('btn-main'); ui.btn.classList.add('btn-logs'); ui.btn.style.flex = "3"; }
            else { ui.btn.classList.add('btn-main'); ui.btn.classList.remove('btn-logs'); ui.btn.style.flex = "3"; }
        }

        /* --- HISTORY MANAGER --- */
        function getHistory() { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
        function saveRun(t) {
            const logs = getHistory();
            logs.unshift({ id: Date.now(), date: new Date().toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit', day:'2-digit', month:'2-digit'}), mode: `${state.modeStart}-${state.modeEnd}`, time: t, name: '' });
            if(logs.length > 50) logs.pop();
            localStorage.setItem(STORAGE_KEY, JSON.stringify(logs)); renderHistory();
        }
        function clearAllLogs() {
            pendingDeleteId = 'ALL';
            ui.confirmModal.classList.add('open');
        }
        function openDelete(id) {
            pendingDeleteId = id;
            ui.confirmModal.classList.add('open');
        }
        function closeConfirm() { ui.confirmModal.classList.remove('open'); pendingDeleteId = null; }
        
        function executeDelete() {
            if(pendingDeleteId === 'ALL') localStorage.removeItem(STORAGE_KEY);
            else {
                let logs = getHistory();
                logs = logs.filter(l => l.id !== pendingDeleteId);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(logs));
            }
            renderHistory();
            closeConfirm();
        }

        function openRename(id) {
            const logs = getHistory();
            const log = logs.find(l => l.id === id);
            if(!log) return;
            pendingRenameId = id;
            ui.renameInput.value = log.name || "";
            ui.renameModal.classList.add('open');
            ui.renameInput.focus();
        }
        function closeRename() { ui.renameModal.classList.remove('open'); pendingRenameId = null; }
        function confirmRename() {
            if(!pendingRenameId) return;
            const val = ui.renameInput.value;
            let logs = getHistory();
            const log = logs.find(l => l.id === pendingRenameId);
            if(log) {
                log.name = val;
                localStorage.setItem(STORAGE_KEY, JSON.stringify(logs));
                renderHistory();
            }
            closeRename();
        }

        function renderHistory() {
            const logs = getHistory();
            ui.histList.innerHTML = logs.length ? '' : '<div style="text-align:center; color:#444; margin-top:20px;">KEINE DATEN</div>';
            logs.forEach(l => {
                const div = document.createElement('div');
                div.className = 'hist-item';
                if(Date.now()-l.id < 5000) div.classList.add('new');
                const displayName = l.name ? l.name : `${l.mode} KM/H`;
                const displayMeta = l.name ? `${l.mode} • ${l.date}` : l.date;
                div.innerHTML = `
                    <div class="h-left"><span class="h-title">${displayName}</span><div class="h-meta"><span>${displayMeta}</span></div></div>
                    <div class="h-right"><span class="h-time">${l.time}s</span>
                    <div class="h-actions"><button class="h-btn" onclick="openRename(${l.id})">✎</button><button class="h-btn del" onclick="openDelete(${l.id})">×</button></div></div>`;
                ui.histList.appendChild(div);
            });
        }

        /* --- VISUALS --- */
        function loop() {
            let diff = state.speed - state.displaySpeed;
            state.displaySpeed += diff * 0.15; 
            ui.digi.textContent = Math.round(state.displaySpeed);
            drawTacho(); requestAnimationFrame(loop);
        }
        function drawTacho() {
            if (dim.r <= 20) return;
            ctx.clearRect(0,0, dim.w, dim.h);
            const start = 0.75 * Math.PI; const end = 2.25 * Math.PI; const range = end - start;
            ctx.beginPath(); ctx.arc(dim.cx, dim.cy, dim.r, start, end);
            ctx.lineWidth = 20; ctx.lineCap = 'round'; ctx.strokeStyle = '#111'; ctx.stroke();
            for(let i=0; i<=MAX_SPEED; i+=10) {
                const norm = i / MAX_SPEED; const ang = start + (norm * range);
                const isMajor = (i % 20 === 0);
                const rOut = dim.r - 15; const rIn = rOut - (isMajor ? 12 : 6);
                ctx.beginPath(); ctx.moveTo(dim.cx + Math.cos(ang)*rOut, dim.cy + Math.sin(ang)*rOut);
                ctx.lineTo(dim.cx + Math.cos(ang)*rIn, dim.cy + Math.sin(ang)*rIn);
                ctx.strokeStyle = i>=220 ? '#ff2a2a' : '#444'; ctx.lineWidth = isMajor ? 3 : 1; ctx.stroke();
                if(isMajor) {
                    const rText = dim.r - 40;
                    ctx.fillStyle = "#888"; ctx.font = "bold 13px Orbitron"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
                    ctx.fillText(i, dim.cx + Math.cos(ang) * rText, dim.cy + Math.sin(ang) * rText);
                }
            }
            const norm = Math.min(state.displaySpeed/MAX_SPEED, 1);
            if(norm > 0.01) {
                const cur = start + (norm*range);
                const grad = ctx.createLinearGradient(0, dim.h, dim.w, 0);
                grad.addColorStop(0, '#00f3ff'); grad.addColorStop(0.6, '#bc13fe'); grad.addColorStop(1, '#ff2a2a');
                ctx.beginPath(); ctx.arc(dim.cx, dim.cy, dim.r, start, cur);
                ctx.lineWidth = 14; ctx.lineCap = 'round'; ctx.strokeStyle = grad;
                ctx.shadowBlur = 15; ctx.shadowColor = '#00f3ff'; ctx.stroke(); ctx.shadowBlur = 0;
            }
            const angle = start + (norm * range);
            ctx.save(); ctx.translate(dim.cx, dim.cy); ctx.rotate(angle);
            ctx.beginPath(); ctx.moveTo(0, -3); ctx.lineTo(dim.r-10, 0); ctx.lineTo(0, 3);
            ctx.fillStyle = '#fff'; ctx.shadowBlur = 10; ctx.shadowColor = '#fff'; ctx.fill();
            ctx.restore(); ctx.shadowBlur = 0;
            ctx.beginPath(); ctx.arc(dim.cx, dim.cy, 6, 0, Math.PI*2); ctx.fillStyle = "#333"; ctx.fill();
        }

        function startGPS() {
            if(!navigator.geolocation) return;
            ui.gpsDot.className = "dot bad"; ui.gpsTxt.textContent = "SUCHE...";
            navigator.geolocation.watchPosition(pos => {
                if(state.isSimulating) return;
                ui.gpsDot.className = "dot ok"; ui.gpsTxt.textContent = "GPS OK";
                let s = pos.coords.speed; if(s==null||s<0) s=0; if(s<0.25) s=0;
                state.speed = s * 3.6; checkLogic();
            }, err => { if(!state.isSimulating) { ui.gpsDot.className = "dot bad"; ui.gpsTxt.textContent = "LOST"; } }, {enableHighAccuracy:true, maximumAge:0});
        }
        init();
    </script>
</body>
</html>
