<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Cockpit Tacho</title>
    <!-- Importiere futuristischen Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #050505;
            --bg-panel: rgba(30, 30, 40, 0.6);
            --accent-cyan: #00f3ff;
            --accent-purple: #bc13fe;
            --accent-red: #ff2a2a;
            --accent-green: #0aff60;
            --text-main: #ffffff;
            --text-muted: #8888aa;
        }

        body {
            font-family: 'Orbitron', sans-serif; /* Cockpit Font */
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 30%, #1a1a25 0%, #000000 70%);
            color: var(--text-main);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
            user-select: none;
        }

        .container {
            width: 100%;
            max-width: 500px;
            padding: 10px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            justify-content: space-between;
            padding-bottom: 20px;
        }

        /* TACHO BEREICH */
        .gauge-container {
            position: relative;
            width: 100%;
            max-width: 360px;
            aspect-ratio: 1/1;
            margin-top: 10px;
            filter: drop-shadow(0 0 20px rgba(0, 243, 255, 0.1));
        }

        canvas { width: 100%; height: 100%; }

        /* Digitaler Wert in der Mitte */
        .digital-center {
            position: absolute;
            top: 55%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 10;
            pointer-events: none;
        }

        .speed-big {
            font-size: 4.5rem;
            font-weight: 700;
            line-height: 0.9;
            background: linear-gradient(180deg, #fff, #aaa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        .unit-label {
            font-size: 0.8rem;
            color: var(--accent-cyan);
            letter-spacing: 3px;
            margin-top: 5px;
            opacity: 0.8;
        }

        /* STEUERUNG (Glasmorphismus) */
        .controls-panel {
            width: 100%;
            background: var(--bg-panel);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 24px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
        }

        /* Mode Buttons */
        .mode-row {
            display: flex;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 4px;
        }

        .mode-btn {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem;
            padding: 12px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
        }

        .mode-btn.active {
            background: rgba(255,255,255,0.1);
            color: var(--accent-cyan);
            text-shadow: 0 0 8px var(--accent-cyan);
            font-weight: 700;
        }

        /* Timer & Status */
        .info-box {
            text-align: center;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .timer-val {
            font-size: 3rem;
            color: var(--text-main);
            text-shadow: 0 0 10px rgba(255,255,255,0.3);
        }

        .status-msg {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Hold Bar (Rolling Start) */
        .hold-track {
            width: 100%;
            height: 4px;
            background: #222;
            margin-top: 10px;
            border-radius: 2px;
            overflow: hidden;
            display: none;
        }
        .hold-fill {
            height: 100%;
            width: 0%;
            background: var(--accent-cyan);
            box-shadow: 0 0 10px var(--accent-cyan);
            transition: width 0.1s linear;
        }

        /* Main Button */
        .btn-main {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 14px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .btn-start {
            background: linear-gradient(90deg, var(--accent-cyan), #00aaff);
            color: #000;
            box-shadow: 0 5px 20px rgba(0, 243, 255, 0.3);
        }
        
        .btn-start:active { transform: scale(0.98); opacity: 0.9; }

        .btn-stop {
            background: rgba(255, 42, 42, 0.2);
            border: 1px solid var(--accent-red);
            color: var(--accent-red);
            text-shadow: 0 0 8px var(--accent-red);
        }

        /* Countdown Overlay (0-100) */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(10px);
            z-index: 100;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .overlay.active { opacity: 1; pointer-events: auto; }
        
        .cnt-num {
            font-size: 10rem; font-weight: 900;
            color: transparent;
            -webkit-text-stroke: 2px var(--accent-cyan);
            text-shadow: 0 0 30px var(--accent-cyan);
            animation: zoomPulse 0.8s ease-out;
        }
        @keyframes zoomPulse { 
            0% { transform: scale(0.5); opacity: 0; }
            60% { transform: scale(1.2); opacity: 1; } 
            100% { transform: scale(1); } 
        }

        /* GPS Status */
        .gps-stat {
            position: absolute; top: 10px; right: 10px;
            font-size: 0.7rem; color: #555;
            display: flex; align-items: center; gap: 6px;
            background: rgba(0,0,0,0.5); padding: 4px 10px; border-radius: 20px;
            border: 1px solid #333; z-index: 50;
        }
        .dot { width: 6px; height: 6px; border-radius: 50%; background: #444; }
        .dot.ok { background: var(--accent-green); box-shadow: 0 0 6px var(--accent-green); }
        .dot.bad { background: #ffcc00; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.3; } }

    </style>
</head>
<body>

    <!-- Overlay -->
    <div id="overlay" class="overlay">
        <div id="overlayText" class="cnt-num">3</div>
    </div>

    <!-- GPS -->
    <div class="gps-stat">
        <div id="gpsDot" class="dot"></div>
        <span id="gpsTxt">NO GPS</span>
    </div>

    <div class="container">
        <!-- TACHO -->
        <div class="gauge-container">
            <canvas id="gaugeCanvas"></canvas>
            <div class="digital-center">
                <div class="speed-big" id="digiSpeed">0</div>
                <div class="unit-label">KM/H</div>
            </div>
        </div>

        <!-- STEUERUNG -->
        <div class="controls-panel">
            <div class="mode-row">
                <button class="mode-btn active" onclick="setMode(0, 100, this)">0 - 100</button>
                <button class="mode-btn" onclick="setMode(10, 100, this)">10 - 100</button>
                <button class="mode-btn" onclick="setMode(100, 200, this)">100 - 200</button>
            </div>

            <div class="info-box">
                <div class="timer-val" id="timer">0.00</div>
                <div class="status-msg" id="status">Bereit</div>
                
                <div class="hold-track" id="holdTrack">
                    <div class="hold-fill" id="holdFill"></div>
                </div>
            </div>

            <button class="btn-main btn-start" onclick="handleBtn()" id="mainBtn">START</button>
        </div>
    </div>

    <script>
        /* --- CONFIG --- */
        const MAX_SPEED = 260;
        const HOLD_TIME = 3000; // 3 sekunden
        const TOLERANCE = 2.0; 

        /* --- STATE --- */
        let state = {
            speed: 0,
            displaySpeed: 0, // Geglättet
            
            modeStart: 0,
            modeEnd: 100,
            
            // Workflow: IDLE -> COUNTDOWN -> CHECK_ROLLING -> HOLDING -> ARMED -> RUNNING -> FINISHED
            phase: 'IDLE',
            
            startTime: 0,
            holdStart: 0,
            
            loopId: null,
            timerId: null
        };

        /* --- UI ELEMENTS --- */
        const ui = {
            can: document.getElementById('gaugeCanvas'),
            digi: document.getElementById('digiSpeed'),
            timer: document.getElementById('timer'),
            status: document.getElementById('status'),
            btn: document.getElementById('mainBtn'),
            ovl: document.getElementById('overlay'),
            ovlTxt: document.getElementById('overlayText'),
            holdTrack: document.getElementById('holdTrack'),
            holdFill: document.getElementById('holdFill'),
            gpsDot: document.getElementById('gpsDot'),
            gpsTxt: document.getElementById('gpsTxt')
        };
        const ctx = ui.can.getContext('2d');
        let dim = { w:0, h:0, cx:0, cy:0, r:0 };

        /* --- INIT --- */
        function init() {
            resize();
            window.addEventListener('resize', resize);
            loop(); // Visueller Loop
            startGPS();
        }

        function resize() {
            const dpr = window.devicePixelRatio || 1;
            const rect = ui.can.parentElement.getBoundingClientRect();
            ui.can.width = rect.width * dpr;
            ui.can.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            dim.w = rect.width; dim.h = rect.height;
            dim.cx = dim.w/2; dim.cy = dim.h/2; 
            dim.r = (dim.w/2) - 15; // Padding für Glow
        }

        /* --- LOGIK (Übernommen aus Vorversion) --- */
        function setMode(s, e, el) {
            if(state.phase !== 'IDLE' && state.phase !== 'FINISHED') return;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            state.modeStart = s; state.modeEnd = e;
            resetAll();
            ui.status.textContent = `MODUS: ${s} - ${e}`;
        }

        function handleBtn() {
            if(state.phase !== 'IDLE' && state.phase !== 'FINISHED') {
                resetAll();
                return;
            }
            // Start
            if(state.modeStart === 0) startStaticSequence();
            else startRollingSequence();
        }

        // 0-100 Sequenz
        function startStaticSequence() {
            state.phase = 'COUNTDOWN';
            setBtnState('stop');
            ui.ovl.classList.add('active');
            
            let c = 3;
            updateOverlay(c);
            
            let iv = setInterval(() => {
                c--;
                if(c > 0) updateOverlay(c);
                else {
                    clearInterval(iv);
                    updateOverlay("GO");
                    document.getElementById('overlayText').style.webkitTextStroke = "2px #0aff60";
                    document.getElementById('overlayText').style.textShadow = "0 0 30px #0aff60";
                    setTimeout(() => {
                        ui.ovl.classList.remove('active');
                        // Reset style
                        document.getElementById('overlayText').style.webkitTextStroke = "";
                        document.getElementById('overlayText').style.textShadow = "";
                        arm("GIB GAS!");
                    }, 800);
                }
            }, 1000);
        }

        function updateOverlay(txt) {
            const el = ui.ovlTxt;
            el.style.animation = 'none';
            el.offsetHeight; // trigger reflow
            el.style.animation = 'zoomPulse 0.8s ease-out';
            el.textContent = txt;
        }

        // Rolling Sequenz
        function startRollingSequence() {
            state.phase = 'CHECK_ROLLING';
            setBtnState('stop');
            ui.holdTrack.style.display = 'block';
            ui.holdFill.style.width = '0%';
            ui.status.textContent = `HALTE ${state.modeStart} KM/H (±${TOLERANCE})`;
            ui.status.style.color = "var(--accent-cyan)";
        }

        function checkLogic() {
            // Wird bei jedem GPS Tick gerufen
            if(state.phase === 'IDLE' || state.phase === 'FINISHED') return;

            // Rolling: Check Speed
            if(state.phase === 'CHECK_ROLLING') {
                const min = state.modeStart - TOLERANCE;
                const max = state.modeStart + TOLERANCE;
                if(state.speed >= min && state.speed <= max) {
                    state.phase = 'HOLDING';
                    state.holdStart = Date.now();
                } else {
                    if(state.speed < min) ui.status.textContent = `ZU LANGSAM (${Math.round(state.speed)})`;
                    else ui.status.textContent = `ZU SCHNELL (${Math.round(state.speed)})`;
                    ui.status.style.color = "#ffcc00";
                }
            }

            // Rolling: Hold Timer
            if(state.phase === 'HOLDING') {
                const min = state.modeStart - TOLERANCE;
                const max = state.modeStart + TOLERANCE;
                
                if(state.speed < min || state.speed > max) {
                    state.phase = 'CHECK_ROLLING';
                    ui.holdFill.style.width = '0%';
                    ui.status.textContent = "BEREICH VERLASSEN!";
                    ui.status.style.color = "var(--accent-red)";
                    return;
                }

                const elapsed = Date.now() - state.holdStart;
                const prog = Math.min((elapsed/HOLD_TIME)*100, 100);
                ui.holdFill.style.width = prog + '%';
                ui.status.textContent = "HALTEN...";
                ui.status.style.color = "var(--accent-cyan)";

                if(elapsed >= HOLD_TIME) {
                    state.phase = 'ARMED';
                    ui.holdFill.style.background = "var(--accent-green)";
                    ui.holdFill.style.boxShadow = "0 0 10px var(--accent-green)";
                    arm("GO! GIB GAS!");
                }
            }

            // Armed: Warten auf Beschleunigung
            if(state.phase === 'ARMED') {
                const trigger = state.modeStart === 0 ? 1.5 : (state.modeStart + TOLERANCE);
                if(state.speed > trigger) {
                    startRun();
                }
            }

            // Running: Check End Speed
            if(state.phase === 'RUNNING') {
                if(state.speed >= state.modeEnd) finishRun();
            }
        }

        function arm(msg) {
            state.phase = 'ARMED';
            ui.status.textContent = msg;
            ui.status.style.color = "var(--accent-green)";
            if(state.modeStart > 0) setTimeout(() => ui.holdTrack.style.display='none', 1000);
        }

        function startRun() {
            state.phase = 'RUNNING';
            state.startTime = Date.now();
            ui.status.textContent = "MESSUNG LÄUFT";
            ui.status.style.color = "var(--accent-cyan)";
            
            // Timer Display Loop
            state.timerId = setInterval(() => {
                const d = (Date.now() - state.startTime)/1000;
                ui.timer.textContent = d.toFixed(2);
            }, 30);
        }

        function finishRun() {
            clearInterval(state.timerId);
            state.phase = 'FINISHED';
            const d = (Date.now() - state.startTime)/1000;
            ui.timer.textContent = d.toFixed(2);
            ui.status.textContent = `ZIEL ERREICHT!`;
            ui.status.style.color = "#fff";
            setBtnState('start', "NEUER START");
        }

        function resetAll() {
            clearInterval(state.timerId);
            state.phase = 'IDLE';
            state.holdStart = 0;
            ui.timer.textContent = "0.00";
            ui.status.textContent = "BEREIT";
            ui.status.style.color = "var(--text-muted)";
            ui.holdTrack.style.display = 'none';
            ui.holdFill.style.width = '0%';
            ui.holdFill.style.background = "var(--accent-cyan)";
            ui.ovl.classList.remove('active');
            setBtnState('start', "START");
        }

        function setBtnState(type, txt) {
            if(type === 'stop') {
                ui.btn.className = "btn-main btn-stop";
                ui.btn.textContent = "ABBRECHEN";
            } else {
                ui.btn.className = "btn-main btn-start";
                ui.btn.textContent = txt || "START";
            }
        }

        /* --- VISUALS (CANVAS) --- */
        function loop() {
            // Smooth Speed
            let diff = state.speed - state.displaySpeed;
            state.displaySpeed += diff * 0.15; // Trägheit
            
            ui.digi.textContent = Math.round(state.displaySpeed);
            
            drawTacho();
            requestAnimationFrame(loop);
        }

        function drawTacho() {
            ctx.clearRect(0,0, dim.w, dim.h);
            
            const startAng = 0.75 * Math.PI; // 135 grad
            const endAng = 2.25 * Math.PI;   // 405 grad
            const range = endAng - startAng;
            
            // 1. Hintergrund Ring (Dunkel)
            ctx.beginPath();
            ctx.arc(dim.cx, dim.cy, dim.r, startAng, endAng);
            ctx.lineWidth = 20;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#111';
            ctx.stroke();

            // 2. Skala Striche (Ticks)
            const steps = MAX_SPEED / 20; 
            for(let i=0; i<=MAX_SPEED; i+=10) {
                const norm = i / MAX_SPEED;
                const ang = startAng + (norm * range);
                const isMajor = (i % 20 === 0);
                
                const rOut = dim.r - 15;
                const rIn = rOut - (isMajor ? 12 : 6);
                
                const x1 = dim.cx + Math.cos(ang)*rOut;
                const y1 = dim.cy + Math.sin(ang)*rOut;
                const x2 = dim.cx + Math.cos(ang)*rIn;
                const y2 = dim.cy + Math.sin(ang)*rIn;

                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.lineWidth = isMajor ? 3 : 1;
                // Rot ab 220
                ctx.strokeStyle = (i >= 220) ? '#ff2a2a' : '#444'; 
                ctx.stroke();
                
                // Zahlen (optional, aber bei cleanem look oft weggelassen oder nur wenige)
                if(isMajor && i%40 === 0) {
                    const rTxt = dim.r - 45;
                    const tx = dim.cx + Math.cos(ang)*rTxt;
                    const ty = dim.cy + Math.sin(ang)*rTxt;
                    ctx.fillStyle = "#666";
                    ctx.font = "12px Orbitron";
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";
                    ctx.fillText(i, tx, ty);
                }
            }

            // 3. Aktiver Bogen (Glow & Gradient)
            const speedNorm = Math.min(state.displaySpeed / MAX_SPEED, 1);
            if(speedNorm > 0.01) {
                const currentAng = startAng + (speedNorm * range);
                
                // Gradient erstellen
                const grad = ctx.createLinearGradient(0, dim.h, dim.w, 0);
                grad.addColorStop(0, '#00f3ff'); // Cyan
                grad.addColorStop(0.6, '#bc13fe'); // Lila
                grad.addColorStop(1, '#ff2a2a'); // Rot

                ctx.beginPath();
                ctx.arc(dim.cx, dim.cy, dim.r, startAng, currentAng);
                ctx.lineWidth = 14;
                ctx.lineCap = 'round';
                ctx.strokeStyle = grad;
                
                // Glow Effekt
                ctx.shadowBlur = 15;
                ctx.shadowColor = '#00f3ff';
                ctx.stroke();
                
                // Reset Shadow
                ctx.shadowBlur = 0;
            }

            // 4. Nadel (Modernes Dreieck)
            drawNeedle(speedNorm, startAng, range);
        }

        function drawNeedle(norm, start, range) {
            const angle = start + (norm * range);
            const rNeedle = dim.r - 5;
            
            ctx.save();
            ctx.translate(dim.cx, dim.cy);
            ctx.rotate(angle);
            
            // Nadel Form
            ctx.beginPath();
            ctx.moveTo(0, -3);
            ctx.lineTo(rNeedle, 0);
            ctx.lineTo(0, 3);
            ctx.fillStyle = "#fff";
            
            // Glow
            ctx.shadowBlur = 10;
            ctx.shadowColor = "#fff";
            ctx.fill();
            
            ctx.restore();
            ctx.shadowBlur = 0; // Reset
            
            // Center Cap
            ctx.beginPath();
            ctx.arc(dim.cx, dim.cy, 8, 0, Math.PI*2);
            ctx.fillStyle = "#222";
            ctx.lineWidth = 2;
            ctx.strokeStyle = "#555";
            ctx.fill();
            ctx.stroke();
        }

        /* --- GPS --- */
        function startGPS() {
            if(!navigator.geolocation) return;
            ui.gpsDot.className = "dot bad";
            ui.gpsTxt.textContent = "SUCHE...";
            
            navigator.geolocation.watchPosition(pos => {
                ui.gpsDot.className = "dot ok";
                ui.gpsTxt.textContent = "GPS OK";
                let s = pos.coords.speed;
                if(s == null || s < 0) s = 0;
                if(s < 0.25) s = 0; // Drift Filter
                
                state.speed = s * 3.6;
                checkLogic();
            }, err => {
                ui.gpsDot.className = "dot bad";
                ui.gpsTxt.textContent = "LOST";
            }, { enableHighAccuracy:true, maximumAge:0 });
        }

        init();
    </script>
</body>
</html>