<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Cockpit Tacho</title>
    <!-- Importiere futuristischen Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #050505;
            --bg-panel: rgba(30, 30, 40, 0.6);
            --accent-cyan: #00f3ff;
            --accent-purple: #bc13fe;
            --accent-red: #ff2a2a;
            --accent-green: #0aff60;
            --text-main: #ffffff;
            --text-muted: #8888aa;
        }

        body {
            font-family: 'Orbitron', sans-serif; /* Cockpit Font */
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 30%, #1a1a25 0%, #000000 70%);
            color: var(--text-main);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
            user-select: none;
        }

        .container {
            width: 100%;
            max-width: 500px;
            padding: 10px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            justify-content: space-between;
            padding-bottom: 20px;
            position: relative;
        }

        /* TACHO BEREICH */
        .gauge-container {
            position: relative;
            width: 100%;
            max-width: 360px;
            aspect-ratio: 1/1;
            margin-top: 10px;
            filter: drop-shadow(0 0 20px rgba(0, 243, 255, 0.1));
        }

        canvas { width: 100%; height: 100%; }

        /* Digitaler Wert in der Mitte */
        .digital-center {
            position: absolute;
            top: 55%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 10;
            pointer-events: none;
        }

        .speed-big {
            font-size: 4.5rem;
            font-weight: 700;
            line-height: 0.9;
            background: linear-gradient(180deg, #fff, #aaa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        .unit-label {
            font-size: 0.8rem;
            color: var(--accent-cyan);
            letter-spacing: 3px;
            margin-top: 5px;
            opacity: 0.8;
        }

        /* STEUERUNG (Glasmorphismus) */
        .controls-panel {
            width: 100%;
            background: var(--bg-panel);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 24px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
            z-index: 20;
        }

        /* Mode Buttons */
        .mode-row {
            display: flex;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 4px;
        }

        .mode-btn {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem;
            padding: 12px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
        }

        .mode-btn.active {
            background: rgba(255,255,255,0.1);
            color: var(--accent-cyan);
            text-shadow: 0 0 8px var(--accent-cyan);
            font-weight: 700;
        }

        /* Timer & Status */
        .info-box {
            text-align: center;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .timer-val {
            font-size: 3rem;
            color: var(--text-main);
            text-shadow: 0 0 10px rgba(255,255,255,0.3);
        }

        .status-msg {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Hold Bar (Rolling Start) */
        .hold-track {
            width: 100%;
            height: 4px;
            background: #222;
            margin-top: 10px;
            border-radius: 2px;
            overflow: hidden;
            display: none;
        }
        .hold-fill {
            height: 100%;
            width: 0%;
            background: var(--accent-cyan);
            box-shadow: 0 0 10px var(--accent-cyan);
            transition: width 0.1s linear;
        }

        /* Action Buttons Area */
        .action-area {
            display: flex;
            gap: 10px;
        }

        /* Main Button */
        .btn-main {
            flex: 3;
            padding: 18px;
            border: none;
            border-radius: 14px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .btn-logs {
            flex: 1;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-muted);
            border-radius: 14px;
            font-family: 'Orbitron', sans-serif;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .btn-start {
            background: linear-gradient(90deg, var(--accent-cyan), #00aaff);
            color: #000;
            box-shadow: 0 5px 20px rgba(0, 243, 255, 0.3);
        }
        
        .btn-start:active { transform: scale(0.98); opacity: 0.9; }

        .btn-stop {
            background: rgba(255, 42, 42, 0.2);
            border: 1px solid var(--accent-red);
            color: var(--accent-red);
            text-shadow: 0 0 8px var(--accent-red);
        }

        /* Countdown Overlay (0-100) */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(10px);
            z-index: 100;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .overlay.active { opacity: 1; pointer-events: auto; }
        
        .cnt-num {
            font-size: 10rem; font-weight: 900;
            color: transparent;
            -webkit-text-stroke: 2px var(--accent-cyan);
            text-shadow: 0 0 30px var(--accent-cyan);
            animation: zoomPulse 0.8s ease-out;
        }
        @keyframes zoomPulse { 
            0% { transform: scale(0.5); opacity: 0; }
            60% { transform: scale(1.2); opacity: 1; } 
            100% { transform: scale(1); } 
        }

        /* Logs / History Modal */
        .history-modal {
            position: absolute;
            bottom: -100%; left: 0; width: 100%; height: 80%;
            background: #0f0f15;
            border-top-left-radius: 30px; border-top-right-radius: 30px;
            box-shadow: 0 -10px 50px rgba(0,0,0,0.8);
            transition: bottom 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 200;
            display: flex; flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
            border-top: 1px solid #333;
        }
        .history-modal.open { bottom: 0; }
        
        .hist-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }
        .hist-title { font-size: 1.2rem; color: var(--accent-cyan); font-weight: 700; }
        .close-btn { background: none; border: none; color: #666; font-size: 1.5rem; cursor: pointer; }
        
        .hist-list {
            flex: 1; overflow-y: auto;
            display: flex; flex-direction: column; gap: 10px;
        }
        
        .hist-item {
            background: #1a1a20;
            padding: 15px; border-radius: 12px;
            display: flex; justify-content: space-between; align-items: center;
            border-left: 3px solid #333;
        }
        .hist-item.new { border-left-color: var(--accent-green); animation: slideIn 0.3s; }
        
        .h-time { font-size: 1.5rem; color: #fff; font-weight: 700; }
        .h-meta { font-size: 0.75rem; color: #666; display: flex; flex-direction: column; gap: 2px; }
        .h-del { background: none; border: none; color: #444; font-size: 1.2rem; cursor: pointer; padding: 5px; }
        .h-del:hover { color: var(--accent-red); }

        @keyframes slideIn { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* GPS Status */
        .gps-stat {
            position: absolute; top: 10px; right: 10px;
            font-size: 0.7rem; color: #555;
            display: flex; align-items: center; gap: 6px;
            background: rgba(0,0,0,0.5); padding: 4px 10px; border-radius: 20px;
            border: 1px solid #333; z-index: 50;
        }
        .dot { width: 6px; height: 6px; border-radius: 50%; background: #444; }
        .dot.ok { background: var(--accent-green); box-shadow: 0 0 6px var(--accent-green); }
        .dot.bad { background: #ffcc00; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.3; } }

    </style>
</head>
<body>

    <!-- Overlay -->
    <div id="overlay" class="overlay">
        <div id="overlayText" class="cnt-num">3</div>
    </div>

    <!-- GPS -->
    <div class="gps-stat">
        <div id="gpsDot" class="dot"></div>
        <span id="gpsTxt">NO GPS</span>
    </div>

    <!-- History Modal -->
    <div class="history-modal" id="histModal">
        <div class="hist-header">
            <span class="hist-title">DATA CENTER</span>
            <button class="close-btn" onclick="toggleHistory()">×</button>
        </div>
        <div class="hist-list" id="histList">
            <!-- Items kommen hier rein -->
        </div>
        <button onclick="clearHistory()" style="margin-top:15px; padding:12px; background:#222; border:none; color:#666; border-radius:8px; font-family:'Orbitron'; cursor:pointer;">ALLE LÖSCHEN</button>
    </div>

    <div class="container">
        <!-- TACHO -->
        <div class="gauge-container">
            <canvas id="gaugeCanvas"></canvas>
            <div class="digital-center">
                <div class="speed-big" id="digiSpeed">0</div>
                <div class="unit-label">KM/H</div>
            </div>
        </div>

        <!-- STEUERUNG -->
        <div class="controls-panel">
            <div class="mode-row">
                <button class="mode-btn active" onclick="setMode(0, 100, this)">0 - 100</button>
                <button class="mode-btn" onclick="setMode(10, 100, this)">10 - 100</button>
                <button class="mode-btn" onclick="setMode(100, 200, this)">100 - 200</button>
            </div>

            <div class="info-box">
                <div class="timer-val" id="timer">0.00</div>
                <div class="status-msg" id="status">Bereit</div>
                
                <div class="hold-track" id="holdTrack">
                    <div class="hold-fill" id="holdFill"></div>
                </div>
            </div>

            <div class="action-area">
                <button class="btn-logs" onclick="toggleHistory()">LOGS</button>
                <button class="btn-main btn-start" onclick="handleBtn()" id="mainBtn">START</button>
            </div>
        </div>
    </div>

    <script>
        /* --- CONFIG --- */
        const MAX_SPEED = 260;
        const HOLD_TIME = 3000; // 3 sekunden
        const TOLERANCE = 2.0; 
        const STATIC_TOLERANCE = 2.0; // km/h, Schwelle für "Stillstand"
        const STORAGE_KEY = 'pro_tacho_logs';

        /* --- STATE --- */
        let state = {
            speed: 0,
            displaySpeed: 0, // Geglättet
            
            modeStart: 0,
            modeEnd: 100,
            
            // Workflow: IDLE -> CHECK_STATIC -> COUNTDOWN -> CHECK_ROLLING -> HOLDING -> ARMED -> RUNNING -> FINISHED
            phase: 'IDLE',
            
            startTime: 0,
            holdStart: 0,
            
            loopId: null,
            timerId: null
        };

        /* --- UI ELEMENTS --- */
        const ui = {
            can: document.getElementById('gaugeCanvas'),
            digi: document.getElementById('digiSpeed'),
            timer: document.getElementById('timer'),
            status: document.getElementById('status'),
            btn: document.getElementById('mainBtn'),
            ovl: document.getElementById('overlay'),
            ovlTxt: document.getElementById('overlayText'),
            holdTrack: document.getElementById('holdTrack'),
            holdFill: document.getElementById('holdFill'),
            gpsDot: document.getElementById('gpsDot'),
            gpsTxt: document.getElementById('gpsTxt'),
            histModal: document.getElementById('histModal'),
            histList: document.getElementById('histList')
        };
        const ctx = ui.can.getContext('2d');
        let dim = { w:0, h:0, cx:0, cy:0, r:0 };

        /* --- INIT --- */
        function init() {
            resize();
            window.addEventListener('resize', resize);
            loop(); // Visueller Loop
            startGPS();
            renderHistory(); // Lade Logs beim Start
        }

        function resize() {
            const dpr = window.devicePixelRatio || 1;
            const rect = ui.can.parentElement.getBoundingClientRect();
            
            if (rect.width === 0 || rect.height === 0) {
                 dim.w = 0; dim.h = 0; dim.r = 0;
                 return;
            }

            ui.can.width = rect.width * dpr;
            ui.can.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            dim.w = rect.width; dim.h = rect.height;
            dim.cx = dim.w/2; dim.cy = dim.h/2; 
            
            dim.r = Math.max(0, (dim.w/2) - 15); 
        }

        /* --- HISTORY LOGIC --- */
        function getHistory() {
            const stored = localStorage.getItem(STORAGE_KEY);
            return stored ? JSON.parse(stored) : [];
        }

        function saveRun(timeVal) {
            const logs = getHistory();
            const newLog = {
                id: Date.now(),
                date: new Date().toLocaleString('de-DE', { day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'}),
                mode: `${state.modeStart}-${state.modeEnd}`,
                time: timeVal
            };
            logs.unshift(newLog); 
            if(logs.length > 50) logs.pop();
            localStorage.setItem(STORAGE_KEY, JSON.stringify(logs));
            renderHistory();
        }

        function deleteLog(id) {
            let logs = getHistory();
            logs = logs.filter(l => l.id !== id);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(logs));
            renderHistory();
        }

        function clearHistory() {
            if(confirm("Alle Logs löschen?")) {
                localStorage.removeItem(STORAGE_KEY);
                renderHistory();
            }
        }

        function renderHistory() {
            const logs = getHistory();
            ui.histList.innerHTML = '';
            
            if(logs.length === 0) {
                ui.histList.innerHTML = '<div style="text-align:center; color:#444; margin-top:20px;">KEINE DATEN</div>';
                return;
            }

            logs.forEach(log => {
                const el = document.createElement('div');
                el.className = 'hist-item';
                if(Date.now() - log.id < 5000) el.classList.add('new');
                
                el.innerHTML = `
                    <div class="h-meta">
                        <span style="color:#888">${log.date}</span>
                        <span style="color:var(--accent-cyan); font-weight:bold">${log.mode} KM/H</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span class="h-time">${log.time}s</span>
                        <button class="h-del" onclick="deleteLog(${log.id})">×</button>
                    </div>
                `;
                ui.histList.appendChild(el);
            });
        }

        function toggleHistory() {
            ui.histModal.classList.toggle('open');
        }

        /* --- LOGIK --- */
        function setMode(s, e, el) {
            if(state.phase !== 'IDLE' && state.phase !== 'FINISHED') return;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            state.modeStart = s; state.modeEnd = e;
            resetAll();
            ui.status.textContent = `MODUS: ${s} - ${e}`;
        }

        function handleBtn() {
            if(state.phase !== 'IDLE' && state.phase !== 'FINISHED') {
                resetAll();
                return;
            }
            // Start Logic
            if(state.modeStart === 0) initStaticStart();
            else startRollingSequence();
        }

        // 0-100 Logic
        function initStaticStart() {
            // Neue Phase: Erst prüfen ob wir stehen
            state.phase = 'CHECK_STATIC';
            setBtnState('stop');
            ui.status.textContent = "BITTE ANHALTEN...";
            ui.status.style.color = "var(--text-muted)";
            // CheckLogik übernimmt ab hier
        }

        function runCountdown() {
            state.phase = 'COUNTDOWN';
            ui.ovl.classList.add('active');
            
            let c = 3;
            updateOverlay(c);
            
            let iv = setInterval(() => {
                c--;
                if(c > 0) updateOverlay(c);
                else {
                    clearInterval(iv);
                    updateOverlay("GO");
                    document.getElementById('overlayText').style.webkitTextStroke = "2px #0aff60";
                    document.getElementById('overlayText').style.textShadow = "0 0 30px #0aff60";
                    setTimeout(() => {
                        ui.ovl.classList.remove('active');
                        // Reset style
                        document.getElementById('overlayText').style.webkitTextStroke = "";
                        document.getElementById('overlayText').style.textShadow = "";
                        arm("GIB GAS!");
                    }, 800);
                }
            }, 1000);
        }

        function updateOverlay(txt) {
            const el = ui.ovlTxt;
            el.style.animation = 'none';
            el.offsetHeight; 
            el.style.animation = 'zoomPulse 0.8s ease-out';
            el.textContent = txt;
        }

        // Rolling Logic
        function startRollingSequence() {
            state.phase = 'CHECK_ROLLING';
            setBtnState('stop');
            ui.holdTrack.style.display = 'block';
            ui.holdFill.style.width = '0%';
            ui.status.textContent = `HALTE ${state.modeStart} KM/H (±${TOLERANCE})`;
            ui.status.style.color = "var(--accent-cyan)";
        }

        function checkLogic() {
            if(state.phase === 'IDLE' || state.phase === 'FINISHED') return;

            // 1. NEU: Check Static (0-100 Modus)
            if(state.phase === 'CHECK_STATIC') {
                if(state.speed < STATIC_TOLERANCE) {
                    // Stehen geblieben -> Countdown starten
                    runCountdown();
                } else {
                    // Bewegt sich noch
                    ui.status.textContent = `ANHALTEN! (${Math.round(state.speed)})`;
                    ui.status.style.color = "var(--accent-red)";
                }
            }

            // 2. Rolling: Check Speed Window
            if(state.phase === 'CHECK_ROLLING') {
                const min = state.modeStart - TOLERANCE;
                const max = state.modeStart + TOLERANCE;
                if(state.speed >= min && state.speed <= max) {
                    state.phase = 'HOLDING';
                    state.holdStart = Date.now();
                } else {
                    if(state.speed < min) ui.status.textContent = `ZU LANGSAM (${Math.round(state.speed)})`;
                    else ui.status.textContent = `ZU SCHNELL (${Math.round(state.speed)})`;
                    ui.status.style.color = "#ffcc00";
                }
            }

            // 3. Rolling: Hold Timer
            if(state.phase === 'HOLDING') {
                const min = state.modeStart - TOLERANCE;
                const max = state.modeStart + TOLERANCE;
                
                if(state.speed < min || state.speed > max) {
                    state.phase = 'CHECK_ROLLING';
                    ui.holdFill.style.width = '0%';
                    ui.status.textContent = "BEREICH VERLASSEN!";
                    ui.status.style.color = "var(--accent-red)";
                    return;
                }

                const elapsed = Date.now() - state.holdStart;
                const prog = Math.min((elapsed/HOLD_TIME)*100, 100);
                ui.holdFill.style.width = prog + '%';
                ui.status.textContent = "HALTEN...";
                ui.status.style.color = "var(--accent-cyan)";

                if(elapsed >= HOLD_TIME) {
                    state.phase = 'ARMED';
                    ui.holdFill.style.background = "var(--accent-green)";
                    ui.holdFill.style.boxShadow = "0 0 10px var(--accent-green)";
                    arm("GO! GIB GAS!");
                }
            }

            // 4. Armed: Wait for Launch
            if(state.phase === 'ARMED') {
                const trigger = state.modeStart === 0 ? 1.5 : (state.modeStart + TOLERANCE);
                if(state.speed > trigger) {
                    startRun();
                }
            }

            // 5. Running
            if(state.phase === 'RUNNING') {
                if(state.speed >= state.modeEnd) finishRun();
            }
        }

        function arm(msg) {
            state.phase = 'ARMED';
            ui.status.textContent = msg;
            ui.status.style.color = "var(--accent-green)";
            if(state.modeStart > 0) setTimeout(() => ui.holdTrack.style.display='none', 1000);
        }

        function startRun() {
            state.phase = 'RUNNING';
            state.startTime = Date.now();
            ui.status.textContent = "MESSUNG LÄUFT";
            ui.status.style.color = "var(--accent-cyan)";
            
            state.timerId = setInterval(() => {
                const d = (Date.now() - state.startTime)/1000;
                ui.timer.textContent = d.toFixed(2);
            }, 30);
        }

        function finishRun() {
            clearInterval(state.timerId);
            state.phase = 'FINISHED';
            const d = (Date.now() - state.startTime)/1000;
            const timeStr = d.toFixed(2);
            
            ui.timer.textContent = timeStr;
            ui.status.textContent = `ZIEL ERREICHT!`;
            ui.status.style.color = "#fff";
            setBtnState('start', "NEUER START");
            
            saveRun(timeStr);
        }

        function resetAll() {
            clearInterval(state.timerId);
            state.phase = 'IDLE';
            state.holdStart = 0;
            ui.timer.textContent = "0.00";
            ui.status.textContent = "BEREIT";
            ui.status.style.color = "var(--text-muted)";
            ui.holdTrack.style.display = 'none';
            ui.holdFill.style.width = '0%';
            ui.holdFill.style.background = "var(--accent-cyan)";
            ui.ovl.classList.remove('active');
            setBtnState('start', "START");
        }

        function setBtnState(type, txt) {
            if(type === 'stop') {
                ui.btn.className = "btn-main btn-stop";
                ui.btn.textContent = "ABBRECHEN";
            } else {
                ui.btn.className = "btn-main btn-start";
                ui.btn.textContent = txt || "START";
            }
        }

        /* --- VISUALS (CANVAS) --- */
        function loop() {
            let diff = state.speed - state.displaySpeed;
            state.displaySpeed += diff * 0.15; 
            
            ui.digi.textContent = Math.round(state.displaySpeed);
            
            drawTacho();
            requestAnimationFrame(loop);
        }

        function drawTacho() {
            if (dim.r <= 20) return;

            ctx.clearRect(0,0, dim.w, dim.h);
            
            const startAng = 0.75 * Math.PI; 
            const endAng = 2.25 * Math.PI;  
            const range = endAng - startAng;
            
            ctx.beginPath();
            ctx.arc(dim.cx, dim.cy, dim.r, startAng, endAng);
            ctx.lineWidth = 20;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#111';
            ctx.stroke();

            const steps = MAX_SPEED / 20; 
            for(let i=0; i<=MAX_SPEED; i+=10) {
                const norm = i / MAX_SPEED;
                const ang = startAng + (norm * range);
                const isMajor = (i % 20 === 0);
                
                const rOut = dim.r - 15;
                const rIn = rOut - (isMajor ? 12 : 6);
                
                const x1 = dim.cx + Math.cos(ang)*rOut;
                const y1 = dim.cy + Math.sin(ang)*rOut;
                const x2 = dim.cx + Math.cos(ang)*rIn;
                const y2 = dim.cy + Math.sin(ang)*rIn;

                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.lineWidth = isMajor ? 3 : 1;
                ctx.strokeStyle = (i >= 220) ? '#ff2a2a' : '#444'; 
                ctx.stroke();
                
                if(isMajor && i%40 === 0) {
                    const rTxt = dim.r - 45;
                    const tx = dim.cx + Math.cos(ang)*rTxt;
                    const ty = dim.cy + Math.sin(ang)*rTxt;
                    ctx.fillStyle = "#666";
                    ctx.font = "12px Orbitron";
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";
                    ctx.fillText(i, tx, ty);
                }
            }

            const speedNorm = Math.min(state.displaySpeed / MAX_SPEED, 1);
            if(speedNorm > 0.01) {
                const currentAng = startAng + (speedNorm * range);
                
                const grad = ctx.createLinearGradient(0, dim.h, dim.w, 0);
                grad.addColorStop(0, '#00f3ff'); 
                grad.addColorStop(0.6, '#bc13fe'); 
                grad.addColorStop(1, '#ff2a2a'); 

                ctx.beginPath();
                ctx.arc(dim.cx, dim.cy, dim.r, startAng, currentAng);
                ctx.lineWidth = 14;
                ctx.lineCap = 'round';
                ctx.strokeStyle = grad;
                
                ctx.shadowBlur = 15;
                ctx.shadowColor = '#00f3ff';
                ctx.stroke();
                ctx.shadowBlur = 0;
            }

            drawNeedle(speedNorm, startAng, range);
        }

        function drawNeedle(norm, start, range) {
            const angle = start + (norm * range);
            const rNeedle = dim.r - 5;
            
            ctx.save();
            ctx.translate(dim.cx, dim.cy);
            ctx.rotate(angle);
            
            ctx.beginPath();
            ctx.moveTo(0, -3);
            ctx.lineTo(rNeedle, 0);
            ctx.lineTo(0, 3);
            ctx.fillStyle = "#fff";
            
            ctx.shadowBlur = 10;
            ctx.shadowColor = "#fff";
            ctx.fill();
            
            ctx.restore();
            ctx.shadowBlur = 0; 
            
            ctx.beginPath();
            ctx.arc(dim.cx, dim.cy, 8, 0, Math.PI*2);
            ctx.fillStyle = "#222";
            ctx.lineWidth = 2;
            ctx.strokeStyle = "#555";
            ctx.fill();
            ctx.stroke();
        }

        /* --- GPS --- */
        function startGPS() {
            if(!navigator.geolocation) return;
            ui.gpsDot.className = "dot bad";
            ui.gpsTxt.textContent = "SUCHE...";
            
            navigator.geolocation.watchPosition(pos => {
                ui.gpsDot.className = "dot ok";
                ui.gpsTxt.textContent = "GPS OK";
                let s = pos.coords.speed;
                if(s == null || s < 0) s = 0;
                if(s < 0.25) s = 0; // Drift Filter
                
                state.speed = s * 3.6;
                checkLogic();
            }, err => {
                ui.gpsDot.className = "dot bad";
                ui.gpsTxt.textContent = "LOST";
            }, { enableHighAccuracy:true, maximumAge:0 });
        }

        init();
    </script>
</body>
</html>
